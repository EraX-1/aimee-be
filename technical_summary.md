# AIMEE ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ æŠ€è¡“å®Ÿè£…ã¾ã¨ã‚

## ğŸ“‹ ç›®æ¬¡
1. [å‡¦ç†ãƒ•ãƒ­ãƒ¼å®Ÿä¾‹](#å‡¦ç†ãƒ•ãƒ­ãƒ¼å®Ÿä¾‹)
2. [æ‰¿èªãƒ»å¦èªæ™‚ã®DBæ›´æ–°å‡¦ç†](#æ‰¿èªå¦èªæ™‚ã®dbæ›´æ–°å‡¦ç†)
3. [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦](#ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦)
4. [ãƒãƒ«ãƒLLMçµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ãƒãƒ«ãƒllmçµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
5. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æº & RAGå®Ÿè£…](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æº--ragå®Ÿè£…)
6. [LLMãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚° & ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæˆ¦ç•¥](#llmãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°--ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæˆ¦ç•¥)
7. [ææ¡ˆç”Ÿæˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ](#ææ¡ˆç”Ÿæˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ )
8. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–)
9. [ã‚³ãƒ¼ãƒ‰å‚ç…§](#ã‚³ãƒ¼ãƒ‰å‚ç…§)

---

## å‡¦ç†ãƒ•ãƒ­ãƒ¼å®Ÿä¾‹

### å…·ä½“çš„ãªå…¥åŠ›ã‹ã‚‰å¿œç­”ã¾ã§ã®æµã‚Œ

#### ä¾‹1: äººå“¡ä¸è¶³ã®è§£æ±ºä¾é ¼

**ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›**:
```
æœ­å¹Œã®ã‚¨ãƒ³ãƒˆãƒª1ã§2åä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã©ã†å¯¾å¿œã™ã‚Œã°ã„ã„ã§ã™ã‹?
```

**ä½¿ç”¨æŠ€è¡“**: 2æ®µéšLLMãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã€RAGã€ææ¡ˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€éåŒæœŸä¸¦åˆ—å‡¦ç†

**å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—**:

1. **æ„å›³è§£æ** (qwen2:0.5b, 0.3ç§’)
   - è¶…è»½é‡ãƒ¢ãƒ‡ãƒ«(0.5B)ã§é«˜é€Ÿå‡¦ç†
   - temperature=0.1ã§æ±ºå®šè«–çš„ãªåˆ†é¡
```json
{
  "intent_type": "delay_resolution",
  "urgency": "high",
  "requires_action": true,
  "entities": {
    "location": "æœ­å¹Œ",
    "process": "ã‚¨ãƒ³ãƒˆãƒª1",
    "issue_type": "äººå“¡ä¸è¶³"
  }
}
```

2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç…§ä¼š** (4ã‚¯ã‚¨ãƒªä¸¦åˆ—å®Ÿè¡Œ, 0.3ç§’)
   - RAG(Retrieval-Augmented Generation)ã«ã‚ˆã‚Šå®Ÿãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
   - async/awaitã§ä¸¦åˆ—å®Ÿè¡Œ
   - ç¾åœ¨ã®é…ç½®çŠ¶æ³: æœ­å¹Œã‚¨ãƒ³ãƒˆãƒª1ã«3åé…ç½®ã€5åå¿…è¦ â†’ 2åä¸è¶³
   - ä½™å‰°äººå“¡æ¤œç´¢: æ±äº¬ã‚¨ãƒ³ãƒˆãƒª1ã«7åé…ç½®ã€5åå¿…è¦ â†’ 2åä½™å‰°(GROUP_CONCATã§ã‚ªãƒšãƒ¬ãƒ¼ã‚¿åã‚‚å–å¾—)
   - ç”Ÿç”£æ€§ãƒˆãƒ¬ãƒ³ãƒ‰: éå»7æ—¥é–“ã®ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§å¹³å‡ç”Ÿç”£æ€§82.5%
   - æœ€è¿‘ã®ã‚¢ãƒ©ãƒ¼ãƒˆ: 24æ™‚é–“ä»¥å†…ã®ãƒ­ã‚°ã‚¤ãƒ³è¨˜éŒ²ã‚’æ™‚ç³»åˆ—ã§å–å¾—

3. **ææ¡ˆç”Ÿæˆ** (ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ , 0.1ç§’)
   - LLMã‚’ä½¿ã‚ãšã€Pythonã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ç¢ºå®Ÿãªé…ç½®æ¡ˆã‚’è¨ˆç®—
   - å„ªå…ˆåº¦ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒãƒ³ã‚°ã§æœ€é©é…åˆ†
```json
{
  "id": "SGT20251003-143052",
  "changes": [
    {
      "from": "æ±äº¬",
      "to": "æœ­å¹Œ",
      "process": "ã‚¨ãƒ³ãƒˆãƒª1",
      "count": 2,
      "operators": ["ç”°ä¸­å¤ªéƒ", "ä½è—¤èŠ±å­"]
    }
  ],
  "impact": {
    "productivity": "+6%",
    "delay": "-20åˆ†",
    "quality": "ç¶­æŒ"
  },
  "reason": "ç”Ÿç”£æ€§å‘ä¸ŠãŒå¿…è¦ï¼ˆ2åã®é…ç½®èª¿æ•´ï¼‰",
  "confidence_score": 0.80
}
```

4. **å¿œç­”ç”Ÿæˆ** (gemma3:4b, 1.5ç§’)
   - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã€Œçµ¶å¯¾åˆ¶ç´„ã€ã‚’åŸ‹ã‚è¾¼ã¿ã€DBãƒ‡ãƒ¼ã‚¿ã®å¼·åˆ¶å‚ç…§ã§ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³é˜²æ­¢
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±+ææ¡ˆæƒ…å ±ã‚’è‡ªç„¶è¨€èªã‚µãƒãƒªãƒ¼ã«å¤‰æ›ã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«æ³¨å…¥
   - temperature=0.7ã§å‰µé€ æ€§ã¨ä¸€è²«æ€§ã®ãƒãƒ©ãƒ³ã‚¹èª¿æ•´
```
æœ­å¹Œã®ã‚¨ãƒ³ãƒˆãƒª1ã§ã®äººå“¡ä¸è¶³ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®é…ç½®è»¢æ›ã‚’ææ¡ˆã—ã¾ã™ã€‚

æœ€é©ææ¡ˆ: æ±äº¬ã®ã‚¨ãƒ³ãƒˆãƒª1ã‹ã‚‰2å(ç”°ä¸­å¤ªéƒã€ä½è—¤èŠ±å­)ã‚’æœ­å¹Œã¸é…ç½®è»¢æ›

å®Ÿè¡Œç†ç”±: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½™å‰°äººå“¡ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãå®Ÿç¾å¯èƒ½ãªé…ç½®å¤‰æ›´
æœŸå¾…åŠ¹æœ:
- ç”Ÿç”£æ€§: +6%å‘ä¸Š
- é…å»¶å‰Šæ¸›: -20åˆ†
- å“è³ª: ç¶­æŒ

ã€Œé…ç½®æ‰¿èªã€ã€Œé…ç½®å¦èªã€ã€Œã•ã‚‰ã«èª¿æ•´ã™ã‚‹ã€ã®ã„ãšã‚Œã‹ã‚’ãŠé¸ã³ãã ã•ã„ã€‚
```

**åˆè¨ˆå‡¦ç†æ™‚é–“**: ç´„2.2ç§’

**æŠ€è¡“çš„ãƒã‚¤ãƒ³ãƒˆ**:
- **ãƒãƒ«ãƒLLM**: æ„å›³è§£æ(0.5B)ã¨å¿œç­”ç”Ÿæˆ(4B)ã§å½¹å‰²åˆ†æ‹…ã€ã‚³ã‚¹ãƒˆå‰Šæ¸›
- **RAGçµ±åˆ**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Ÿãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãå¿œç­”ã§ä¿¡é ¼æ€§ç¢ºä¿
- **ä¸¦åˆ—å‡¦ç†**: 4ã¤ã®DBã‚¯ã‚¨ãƒªã‚’éåŒæœŸã§åŒæ™‚å®Ÿè¡Œ
- **ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³é˜²æ­¢**: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§æ¶ç©ºã®æ‹ ç‚¹åç”Ÿæˆã‚’ç¦æ­¢

---

#### ä¾‹2: æŠ½è±¡çš„ãªå…¥åŠ›ã®æ‹’å¦

**ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›**:
```
ã„ã„æ„Ÿã˜ã«ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™
```

**ä½¿ç”¨æŠ€è¡“**: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°

**å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—**:

1. **æŠ½è±¡å…¥åŠ›æ¤œå‡º** (ollama_service.py:245-261)
   - LLMå‘¼ã³å‡ºã—å‰ã«æ­£è¦è¡¨ç¾ã§ãƒã‚§ãƒƒã‚¯ã€ä¸è¦ãªLLMæ¨è«–ã‚’å›é¿
   - ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°: "ã„ã„æ„Ÿã˜"ã€"ã‚ˆã‚ã—ã"ã€"é©å½“ã«"ã€"ãŠä»»ã›" ãªã©ã‚’æ¤œå‡º
   - å‡¦ç†ã‚’å³åº§ã«ä¸­æ–­ã—ã¦ã‚³ã‚¹ãƒˆå‰Šæ¸›

2. **å¿œç­”ç”Ÿæˆ** (å³åº§)
   - Few-Shot Learningçš„ã«å…·ä½“ä¾‹ã‚’æç¤ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èª˜å°
```
ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€ã‚ˆã‚Šå…·ä½“çš„ãªæƒ…å ±ãŒå¿…è¦ã§ã™ã€‚

ä»¥ä¸‹ã®æƒ…å ±ã‚’æ•™ãˆã¦ãã ã•ã„:
- ã©ã®æ‹ ç‚¹ã§ã®å•é¡Œã§ã™ã‹?
- ã©ã®å·¥ç¨‹ã§ã®å•é¡Œã§ã™ã‹?
- ä½•åä¸è¶³ã—ã¦ã„ã¾ã™ã‹?

ä¾‹: ã€Œæœ­å¹Œã®ã‚¨ãƒ³ãƒˆãƒª1ã§2åä¸è¶³ã—ã¦ã„ã¾ã™ã€
```

**åˆè¨ˆå‡¦ç†æ™‚é–“**: ç´„0.1ç§’

**æŠ€è¡“çš„ãƒã‚¤ãƒ³ãƒˆ**:
- **æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³**: LLMæ¨è«–å‰ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã‚³ã‚¹ãƒˆå‰Šæ¸›
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•™è‚²**: å…·ä½“ä¾‹ã‚’æç¤ºã—ã¦æ¬¡å›ã®å…¥åŠ›å“è³ªã‚’å‘ä¸Š

---

#### ä¾‹3: çŠ¶æ³ç¢ºèªã‚¯ã‚¨ãƒª

**ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›**:
```
ç¾åœ¨ã®é‹ç”¨çŠ¶æ³ã‚’æ•™ãˆã¦ãã ã•ã„
```

**ä½¿ç”¨æŠ€è¡“**: æ„å›³ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªæœ€é©åŒ–ã€é›†ç´„ã‚¯ã‚¨ãƒª

**å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—**:

1. **æ„å›³è§£æ** (qwen2:0.5b, 0.3ç§’)
   - ç·Šæ€¥åº¦(urgency)ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¦æ±‚(requires_action)ã‚’åˆ¤å®š
```json
{
  "intent_type": "status_check",
  "urgency": "low",
  "requires_action": false
}
```

2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç…§ä¼š** (1ã‚¯ã‚¨ãƒª, 0.1ç§’)
   - æ„å›³ã‚¿ã‚¤ãƒ—(status_check)ã«å¿œã˜ã¦ã‚¯ã‚¨ãƒªã‚’æœ€é©åŒ–ã€ä¸è¦ãªãƒ‡ãƒ¼ã‚¿ã¯å–å¾—ã—ãªã„
   - å…¨æ‹ ç‚¹ã®é…ç½®çŠ¶æ³ã‚µãƒãƒªãƒ¼ã‚’GROUP BYã§é›†ç´„ã—ã¦é«˜é€Ÿå–å¾—

3. **å¿œç­”ç”Ÿæˆ** (gemma3:4b, 1.2ç§’)
   - temperature=0.7ã§å‰µé€ æ€§ã¨ä¸€è²«æ€§ã®ãƒãƒ©ãƒ³ã‚¹èª¿æ•´
```
ç¾åœ¨ã®é‹ç”¨çŠ¶æ³ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚

ã€é…ç½®çŠ¶æ³ã€‘
- æœ­å¹Œ: ã‚¨ãƒ³ãƒˆãƒª1(3/5å)ã€æ¢±åŒ…å·¥ç¨‹(5/5å)
- æ±äº¬: ã‚¨ãƒ³ãƒˆãƒª1(7/5å)ã€æ¢±åŒ…å·¥ç¨‹(4/5å)
- å¤§é˜ª: ã‚¨ãƒ³ãƒˆãƒª1(6/5å)ã€æ¢±åŒ…å·¥ç¨‹(5/5å)

ã€äººå“¡çŠ¶æ³ã€‘
- ä¸è¶³: æœ­å¹Œã‚¨ãƒ³ãƒˆãƒª1(-2å)ã€æ±äº¬æ¢±åŒ…å·¥ç¨‹(-1å)
- ä½™å‰°: æ±äº¬ã‚¨ãƒ³ãƒˆãƒª1(+2å)ã€å¤§é˜ªã‚¨ãƒ³ãƒˆãƒª1(+1å)

é…ç½®èª¿æ•´ãŒå¿…è¦ãªå ´åˆã¯ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚
```

**åˆè¨ˆå‡¦ç†æ™‚é–“**: ç´„1.6ç§’

**æŠ€è¡“çš„ãƒã‚¤ãƒ³ãƒˆ**:
- **æ„å›³ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒª**: æ„å›³ã‚¿ã‚¤ãƒ—ã”ã¨ã«æœ€é©ãªSQLã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ(4ç¨®é¡â†’1ç¨®é¡ã«å‰Šæ¸›)
- **ã‚¯ã‚¨ãƒªæœ€é©åŒ–**: GROUP BY + HAVING ã§é›†ç´„å‡¦ç†ã‚’DBå´ã§å®Ÿè¡Œã€ãƒ‡ãƒ¼ã‚¿è»¢é€é‡å‰Šæ¸›

---

## æ‰¿èªãƒ»å¦èªæ™‚ã®DBæ›´æ–°å‡¦ç†

### é…ç½®æ‰¿èªãƒ•ãƒ­ãƒ¼

**ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›**: `é…ç½®æ‰¿èª`

**ä½¿ç”¨æŠ€è¡“**: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã€ACIDä¿è¨¼ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

#### ã‚¹ãƒ†ãƒƒãƒ—1: ææ¡ˆæƒ…å ±ã®ç¢ºèª

ã‚·ã‚¹ãƒ†ãƒ ã¯ç›´å‰ã®ææ¡ˆ(`suggestion_id`)ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—:
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ææ¡ˆIDã‚’ä¿å­˜ã—ã€æ‰¿èª/å¦èªæ™‚ã«å‚ç…§ã—ã¦ä¸€è²«æ€§ã‚’ä¿è¨¼

```json
{
  "id": "SGT20251003-143052",
  "changes": [
    {
      "from": "æ±äº¬",
      "to": "æœ­å¹Œ",
      "process": "ã‚¨ãƒ³ãƒˆãƒª1",
      "count": 2,
      "operators": ["ç”°ä¸­å¤ªéƒ", "ä½è—¤èŠ±å­"]
    }
  ]
}
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹

```sql
START TRANSACTION;
```
- ACIDç‰¹æ€§ã‚’ä¿è¨¼ã€ã‚¨ãƒ©ãƒ¼æ™‚ã¯è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§æ•´åˆæ€§ç¶­æŒ

#### ã‚¹ãƒ†ãƒƒãƒ—3: daily_assignmentsãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°

**3-1. è»¢å‡ºå…ƒ(æ±äº¬)ã®ãƒ¬ã‚³ãƒ¼ãƒ‰å‰Šé™¤**
- ã‚µãƒ–ã‚¯ã‚¨ãƒªã§æ‹ ç‚¹åâ†’IDã®å¤‰æ›ã‚’1ã‚¯ã‚¨ãƒªå†…ã§å®Œçµ

```sql
DELETE FROM daily_assignments
WHERE location_id = (SELECT location_id FROM locations WHERE location_name = 'æ±äº¬')
AND process_id = (SELECT process_id FROM processes WHERE process_name = 'ã‚¨ãƒ³ãƒˆãƒª1')
AND operator_id IN (
    SELECT operator_id FROM operators
    WHERE operator_name IN ('ç”°ä¸­å¤ªéƒ', 'ä½è—¤èŠ±å­')
)
AND assignment_date = CURDATE();
```

**å½±éŸ¿**: æ±äº¬ã‚¨ãƒ³ãƒˆãƒª1ã®é…ç½®äººæ•°ãŒ7å â†’ 5åã«æ¸›å°‘

**3-2. è»¢å…¥å…ˆ(æœ­å¹Œ)ã¸ã®æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰æŒ¿å…¥**
- INSERT-SELECTãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¤‡æ•°ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä¸€æ‹¬æŒ¿å…¥
- assignment_idã¯è‡ªå‹•ç”Ÿæˆ

```sql
INSERT INTO daily_assignments (
    assignment_id,
    location_id,
    business_id,
    process_id,
    operator_id,
    assignment_date,
    created_at
)
SELECT
    CONCAT('ASGN', DATE_FORMAT(NOW(), '%Y%m%d%H%i%s'), '-', operator_id),
    (SELECT location_id FROM locations WHERE location_name = 'æœ­å¹Œ'),
    (SELECT business_id FROM processes WHERE process_name = 'ã‚¨ãƒ³ãƒˆãƒª1'),
    (SELECT process_id FROM processes WHERE process_name = 'ã‚¨ãƒ³ãƒˆãƒª1'),
    operator_id,
    CURDATE(),
    NOW()
FROM operators
WHERE operator_name IN ('ç”°ä¸­å¤ªéƒ', 'ä½è—¤èŠ±å­');
```

**å½±éŸ¿**: æœ­å¹Œã‚¨ãƒ³ãƒˆãƒª1ã®é…ç½®äººæ•°ãŒ3å â†’ 5åã«å¢—åŠ 

#### ã‚¹ãƒ†ãƒƒãƒ—4: suggestion_historyãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®è¨˜éŒ²
- ç›£æŸ»ãƒ­ã‚°ã¨ã—ã¦æ°¸ç¶šåŒ–ã€å¾Œã®åˆ†æãƒ»æ©Ÿæ¢°å­¦ç¿’ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã«æ´»ç”¨

```sql
INSERT INTO suggestion_history (
    suggestion_id,
    suggestion_type,
    from_location,
    to_location,
    process_name,
    operator_count,
    status,
    created_at,
    approved_at
) VALUES (
    'SGT20251003-143052',
    'delay_resolution',
    'æ±äº¬',
    'æœ­å¹Œ',
    'ã‚¨ãƒ³ãƒˆãƒª1',
    2,
    'approved',
    '2025-10-03 14:30:52',
    NOW()
);
```

**å½±éŸ¿**: æ‰¿èªå±¥æ­´ã¨ã—ã¦æ°¸ç¶šåŒ–ã€å¾Œã®åˆ†æãƒ»ç›£æŸ»ã«åˆ©ç”¨å¯èƒ½

#### ã‚¹ãƒ†ãƒƒãƒ—5: ã‚³ãƒŸãƒƒãƒˆ

```sql
COMMIT;
```

#### ã‚¹ãƒ†ãƒƒãƒ—6: å¿œç­”ç”Ÿæˆ

```
é…ç½®è»¢æ›ã‚’æ‰¿èªã—ã¾ã—ãŸã€‚

å®Ÿæ–½å†…å®¹:
- æ±äº¬ã®ã‚¨ãƒ³ãƒˆãƒª1ã‹ã‚‰ç”°ä¸­å¤ªéƒã€ä½è—¤èŠ±å­ã®2åã‚’æœ­å¹Œã¸é…ç½®è»¢æ›
- æœ­å¹Œã‚¨ãƒ³ãƒˆãƒª1: 3å â†’ 5å (ä¸è¶³è§£æ¶ˆ)
- æ±äº¬ã‚¨ãƒ³ãƒˆãƒª1: 7å â†’ 5å (é©æ­£é…ç½®)

ææ¡ˆID: SGT20251003-143052

é…ç½®ã¯å³åº§ã«åæ˜ ã•ã‚Œã¾ã—ãŸã€‚ç”Ÿç”£æ€§ã®æ”¹å–„çŠ¶æ³ã¯æ˜æ—¥ä»¥é™ã®ãƒ¬ãƒãƒ¼ãƒˆã§ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã€‚
```

**æŠ€è¡“çš„ãƒã‚¤ãƒ³ãƒˆ**:
- **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æ•´åˆæ€§**: å‰Šé™¤â†’æŒ¿å…¥â†’å±¥æ­´è¨˜éŒ²ã®3æ“ä½œã‚’ã‚¢ãƒˆãƒŸãƒƒã‚¯ã«å®Ÿè¡Œ
- **äºŒé‡é…ç½®é˜²æ­¢**: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§äººå“¡ã®ç§»å‹•ã‚’å®Œçµã€ä¸­é€”åŠç«¯ãªçŠ¶æ…‹ã‚’æ’é™¤
- **ç›£æŸ»è¨¼è·¡**: å…¨ã¦ã®æ‰¿èªæ“ä½œã‚’å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²ã€ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å¯¾å¿œ

---

### é…ç½®å¦èªãƒ•ãƒ­ãƒ¼

**ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›**: `é…ç½®å¦èª`

**ä½¿ç”¨æŠ€è¡“**: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒ—ã€ä»£æ›¿æ¡ˆç”Ÿæˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

#### ã‚¹ãƒ†ãƒƒãƒ—1: ææ¡ˆæƒ…å ±ã®ç¢ºèª

æ‰¿èªæ™‚ã¨åŒã˜ãã€ç›´å‰ã®ææ¡ˆæƒ…å ±ã‚’å–å¾—

#### ã‚¹ãƒ†ãƒƒãƒ—2: suggestion_historyãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®è¨˜éŒ²
- å¦èªç†ç”±ã‚‚è¨˜éŒ²ã—ã€ææ¡ˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ”¹å–„ã«æ´»ç”¨

```sql
INSERT INTO suggestion_history (
    suggestion_id,
    suggestion_type,
    from_location,
    to_location,
    process_name,
    operator_count,
    status,
    created_at,
    rejected_at,
    rejection_reason
) VALUES (
    'SGT20251003-143052',
    'delay_resolution',
    'æ±äº¬',
    'æœ­å¹Œ',
    'ã‚¨ãƒ³ãƒˆãƒª1',
    2,
    'rejected',
    '2025-10-03 14:30:52',
    NOW(),
    'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹å¦èª'
);
```

**å½±éŸ¿**:
- daily_assignmentsãƒ†ãƒ¼ãƒ–ãƒ«ã¯å¤‰æ›´ãªã—(ç¾çŠ¶ç¶­æŒ)
- å¦èªå±¥æ­´ã®ã¿è¨˜éŒ²(ææ¡ˆã®æ”¹å–„ã«æ´»ç”¨)

#### ã‚¹ãƒ†ãƒƒãƒ—3: ä»£æ›¿ææ¡ˆã®ç”Ÿæˆ

ã‚·ã‚¹ãƒ†ãƒ ã¯æ–°ãŸãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç…§ä¼šã‚’å®Ÿè¡Œã—ã€åˆ¥ã®é…ç½®æ¡ˆã‚’ææ¡ˆ:
- å¦èªã•ã‚ŒãŸææ¡ˆã‚’é™¤å¤–ãƒ•ã‚£ãƒ«ã‚¿ã«è¿½åŠ ã—ã€åŒã˜æ¡ˆã‚’å†ææ¡ˆã—ãªã„

```
æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚åˆ¥ã®é…ç½®æ¡ˆã‚’æ¤œè¨ã—ã¾ã™ã€‚

ä»£æ›¿æ¡ˆ:
- å¤§é˜ªã®ã‚¨ãƒ³ãƒˆãƒª1ã‹ã‚‰éˆ´æœ¨ä¸€éƒã®1åã‚’æœ­å¹Œã¸é…ç½®è»¢æ›
- æ®‹ã‚Š1åã¯æ–°è¦æ¡ç”¨ã¾ãŸã¯æ™‚é–“å¤–å‹¤å‹™ã§å¯¾å¿œ

ã“ã¡ã‚‰ã®æ¡ˆã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹?
ã€Œé…ç½®æ‰¿èªã€ã€Œé…ç½®å¦èªã€ã€Œã•ã‚‰ã«èª¿æ•´ã™ã‚‹ã€
```

**æŠ€è¡“çš„ãƒã‚¤ãƒ³ãƒˆ**:
- **å­¦ç¿’ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**: å¦èªãƒ‡ãƒ¼ã‚¿ã‚’è“„ç©ã—ã€å°†æ¥ã®ææ¡ˆç²¾åº¦å‘ä¸Šã«æ´»ç”¨
- **ä»£æ›¿æ¡ˆç”Ÿæˆ**: ææ¡ˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å†å®Ÿè¡Œã—ã€2ç•ªç›®ã«æœ€é©ãªæ¡ˆã‚’æç¤º

---

### ã•ã‚‰ã«èª¿æ•´ã™ã‚‹ãƒ•ãƒ­ãƒ¼

**ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›**: `ã•ã‚‰ã«èª¿æ•´ã™ã‚‹`

**ä½¿ç”¨æŠ€è¡“**: å¯¾è©±çš„åˆ¶ç´„åé›†ã€å‹•çš„ã‚¯ã‚¨ãƒªç”Ÿæˆ

#### ã‚¹ãƒ†ãƒƒãƒ—1: è©³ç´°æƒ…å ±ã®è¦æ±‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã‚’æ·±æ˜ã‚Šã—ã€ã‚ˆã‚Šæœ€é©ãªææ¡ˆã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®æƒ…å ±åé›†

```
æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚ã‚ˆã‚Šæœ€é©ãªé…ç½®æ¡ˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’ãŠèã‹ã›ãã ã•ã„:

1. ç‰¹å®šã®æ‹ ç‚¹ã‹ã‚‰é…ç½®è»¢æ›ã—ãŸã„ã§ã™ã‹?
2. ç‰¹å®šã®ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’å„ªå…ˆ/é™¤å¤–ã—ãŸã„ã§ã™ã‹?
3. é…ç½®æ™‚æœŸã«åˆ¶ç´„ã¯ã‚ã‚Šã¾ã™ã‹?(å³åº§/ç¿Œæ—¥ä»¥é™)
4. ãã®ä»–ã®è¦æœ›ã¯ã‚ã‚Šã¾ã™ã‹?
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: è¿½åŠ æƒ…å ±ã®å–å¾—ã¨å†ææ¡ˆ

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¿½åŠ æƒ…å ±ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã‚·ã‚¹ãƒ†ãƒ ã¯:
1. æ–°ãŸãªæ„å›³è§£æã‚’å®Ÿè¡Œ
2. è¿½åŠ ã®åˆ¶ç´„æ¡ä»¶ã‚’WHEREå¥ã«å‹•çš„ã«è¿½åŠ  (ä¾‹: `AND o.hometown = 'æœ­å¹Œ'`)
3. æ”¹å–„ã•ã‚ŒãŸææ¡ˆã‚’ç”Ÿæˆ
4. SQLã‚¯ã‚¨ãƒªã‚’å‹•çš„ã«æ§‹ç¯‰ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç´°ã‹ã„è¦æœ›ã«å¯¾å¿œ

**ä¾‹**:
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: ç”°ä¸­å¤ªéƒã¯æœ­å¹Œå‡ºèº«ãªã®ã§å„ªå…ˆã—ã¦ãã ã•ã„

ã‚·ã‚¹ãƒ†ãƒ : æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚ç”°ä¸­å¤ªéƒã‚’å„ªå…ˆã—ãŸé…ç½®æ¡ˆã‚’ä½œæˆã—ã¾ã™ã€‚

æœ€é©ææ¡ˆ: æ±äº¬ã®ã‚¨ãƒ³ãƒˆãƒª1ã‹ã‚‰ç”°ä¸­å¤ªéƒã‚’å«ã‚€2åã‚’æœ­å¹Œã¸é…ç½®è»¢æ›
- ç”°ä¸­å¤ªéƒ(æœ­å¹Œå‡ºèº«ã€å„ªå…ˆé…ç½®)
- ä½è—¤èŠ±å­(çµŒé¨“è±Šå¯Œ)

ã€Œé…ç½®æ‰¿èªã€ã€Œé…ç½®å¦èªã€ã€Œã•ã‚‰ã«èª¿æ•´ã™ã‚‹ã€
```

**æŠ€è¡“çš„ãƒã‚¤ãƒ³ãƒˆ**:
- **å¯¾è©±çš„åˆ¶ç´„åé›†**: è¤‡æ•°å›ã®ã‚„ã‚Šå–ã‚Šã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›ã‚’æ˜ç¢ºåŒ–
- **å‹•çš„ã‚¯ã‚¨ãƒªç”Ÿæˆ**: åˆ¶ç´„æ¡ä»¶ã«å¿œã˜ã¦SQLã®WHEREå¥ã‚’å‹•çš„ã«æ§‹ç¯‰
- **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¿æŒ**: ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§ä¼šè©±å±¥æ­´ã‚’ç¶­æŒã—ã€æ–‡è„ˆã‚’ç†è§£

---

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 

#### suggestion_history (ææ¡ˆå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«)

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | èª¬æ˜ |
|---------|---------|------|
| `suggestion_id` | VARCHAR(50) | ææ¡ˆID (ä¸»ã‚­ãƒ¼) |
| `suggestion_type` | VARCHAR(50) | ææ¡ˆã‚¿ã‚¤ãƒ— |
| `from_location` | VARCHAR(100) | è»¢å‡ºå…ƒæ‹ ç‚¹ |
| `to_location` | VARCHAR(100) | è»¢å…¥å…ˆæ‹ ç‚¹ |
| `process_name` | VARCHAR(100) | å·¥ç¨‹å |
| `operator_count` | INT | é…ç½®è»¢æ›äººæ•° |
| `status` | ENUM('approved', 'rejected', 'pending') | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| `created_at` | DATETIME | ææ¡ˆä½œæˆæ—¥æ™‚ |
| `approved_at` | DATETIME | æ‰¿èªæ—¥æ™‚ |
| `rejected_at` | DATETIME | å¦èªæ—¥æ™‚ |
| `rejection_reason` | TEXT | å¦èªç†ç”± |

#### daily_assignments (æ—¥æ¬¡é…ç½®ãƒ†ãƒ¼ãƒ–ãƒ«)

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | èª¬æ˜ |
|---------|---------|------|
| `assignment_id` | VARCHAR(50) | é…ç½®ID (ä¸»ã‚­ãƒ¼) |
| `location_id` | VARCHAR(50) | æ‹ ç‚¹ID |
| `business_id` | VARCHAR(50) | æ¥­å‹™ID |
| `process_id` | VARCHAR(50) | å·¥ç¨‹ID |
| `operator_id` | VARCHAR(50) | ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ID |
| `assignment_date` | DATE | é…ç½®æ—¥ |
| `created_at` | DATETIME | ä½œæˆæ—¥æ™‚ |
| `updated_at` | DATETIME | æ›´æ–°æ—¥æ™‚ |

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
```sql
CREATE INDEX idx_daily_assignments_date ON daily_assignments(assignment_date);
CREATE INDEX idx_daily_assignments_location ON daily_assignments(location_id);
CREATE INDEX idx_daily_assignments_operator ON daily_assignments(operator_id);
```

---

### ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æ•´åˆæ€§ã®ä¿è¨¼

#### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚·ãƒŠãƒªã‚ª

é…ç½®æ‰¿èªå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ:
- Pythonã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼(`async with db.begin()`)ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è‡ªå‹•ç®¡ç†

```python
try:
    async with db.begin():  # ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
        # è»¢å‡ºå…ƒã‹ã‚‰ã®å‰Šé™¤
        await db.execute(delete_query)

        # è»¢å…¥å…ˆã¸ã®è¿½åŠ 
        await db.execute(insert_query)

        # å±¥æ­´è¨˜éŒ²
        await db.execute(history_query)

        # å…¨ã¦æˆåŠŸã—ãŸå ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
except Exception as e:
    # ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯è‡ªå‹•çš„ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    app_logger.error(f"é…ç½®æ‰¿èªã‚¨ãƒ©ãƒ¼: {str(e)}")
    return {
        "status": "error",
        "message": "é…ç½®æ‰¿èªã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
    }
```

**ä¿è¨¼ã•ã‚Œã‚‹æ•´åˆæ€§**:
- è»¢å‡ºå…ƒã¨è»¢å…¥å…ˆã®ä¸¡æ–¹ãŒæ›´æ–°ã•ã‚Œã‚‹ã‹ã€ä¸¡æ–¹ã¨ã‚‚æ›´æ–°ã•ã‚Œãªã„
- éƒ¨åˆ†çš„ãªæ›´æ–°ã«ã‚ˆã‚‹äººå“¡ã®äºŒé‡é…ç½®/æ¶ˆå¤±ã‚’é˜²æ­¢
- å±¥æ­´è¨˜éŒ²ã®ä¿¡é ¼æ€§ç¢ºä¿

---

### æ‰¿èªãƒ»å¦èªå¾Œã®ç›£è¦–

#### é…ç½®æ‰¿èªå¾Œã®è‡ªå‹•ç›£è¦–

æ‰¿èªã‹ã‚‰24æ™‚é–“å¾Œã€ã‚·ã‚¹ãƒ†ãƒ ã¯è‡ªå‹•çš„ã«ä»¥ä¸‹ã‚’å®Ÿè¡Œ:
- ãƒãƒƒãƒå‡¦ç†ã§å®šæœŸçš„ã«åŠ¹æœæ¸¬å®šã‚’å®Ÿæ–½ã—ã€ææ¡ˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ç²¾åº¦ã‚’æ”¹å–„

1. **ç”Ÿç”£æ€§å¤‰åŒ–ã®æ¸¬å®š**
   - é…ç½®å‰å¾Œã®ç”Ÿç”£æ€§ã‚’æ¯”è¼ƒã—ã€å®Ÿéš›ã®åŠ¹æœã‚’å®šé‡è©•ä¾¡
```sql
SELECT
    AVG(work_count) as avg_productivity
FROM operator_work_records
WHERE location_id = (SELECT location_id FROM locations WHERE location_name = 'æœ­å¹Œ')
AND process_id = (SELECT process_id FROM processes WHERE process_name = 'ã‚¨ãƒ³ãƒˆãƒª1')
AND record_date BETWEEN DATE_SUB(CURDATE(), INTERVAL 1 DAY) AND CURDATE();
```

2. **ææ¡ˆåŠ¹æœã®è©•ä¾¡**
   - äºˆæ¸¬å€¤ã¨å®Ÿæ¸¬å€¤ã‚’æ¯”è¼ƒã—ã€prediction_accuracy(äºˆæ¸¬ç²¾åº¦)ã‚’ç®—å‡º
```sql
UPDATE suggestion_history
SET
    actual_productivity_gain = :measured_gain,
    prediction_accuracy = :accuracy_score
WHERE suggestion_id = 'SGT20251003-143052';
```

3. **ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒ—**
   - æ©Ÿæ¢°å­¦ç¿’çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ææ¡ˆå“è³ªã‚’ç¶™ç¶šçš„ã«æ”¹å–„
   - äºˆæ¸¬ç²¾åº¦ãŒä½ã„å ´åˆã€ææ¡ˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´(ä¾‹: å½±éŸ¿äºˆæ¸¬ã®ä¿‚æ•°ã‚’ä¿®æ­£)
   - æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ç¿’ã—ã€å°†æ¥ã®ææ¡ˆå“è³ªã‚’å‘ä¸Š

**æŠ€è¡“çš„ãƒã‚¤ãƒ³ãƒˆ**:
- **è‡ªå‹•åŠ¹æœæ¸¬å®š**: äººæ‰‹ã‚’ä»‹ã•ãšã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•ã§ææ¡ˆã®åŠ¹æœã‚’è©•ä¾¡
- **ç¶™ç¶šçš„æ”¹å–„**: å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’è‡ªå‹•ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

---

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | æŠ€è¡“ | å½¹å‰² |
|---------|------|------|
| **API** | FastAPI 0.104+ | éåŒæœŸREST API |
| **LLM** | Ollama (qwen2:0.5b + gemma3:4b/12b/27b) | ãƒãƒ«ãƒãƒ¢ãƒ‡ãƒ«LLMæ¨è«– |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** | MySQL 8.0 + aiomysql | éåŒæœŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ |
| **ã‚­ãƒ£ãƒƒã‚·ãƒ¥** | Redis 7 | é«˜é€Ÿãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |
| **ãƒ™ã‚¯ãƒˆãƒ«DB** | ChromaDB | RAGãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ |
| **ã‚³ãƒ³ãƒ†ãƒŠ** | Docker + Docker Compose | ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹æ§‹æˆ |

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FastAPI (Port 8000)                   â”‚
â”‚                     çµ±åˆLLMã‚µãƒ¼ãƒ“ã‚¹å±¤                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è»½é‡LLM      â”‚      â”‚  ãƒ¡ã‚¤ãƒ³LLM     â”‚
â”‚  qwen2:0.5b   â”‚      â”‚ gemma3:4b/12b â”‚
â”‚  æ„å›³è§£æ     â”‚      â”‚  27bå¯¾å¿œ      â”‚
â”‚  Port 11433   â”‚      â”‚  Port 11434   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                   â”‚
        â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MySQL 8.0    â”‚      â”‚  ChromaDB + Redis        â”‚
â”‚  æ¥­å‹™ãƒ‡ãƒ¼ã‚¿    â”‚      â”‚  ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ + ã‚­ãƒ£ãƒƒã‚·ãƒ¥ â”‚
â”‚  Port 3306    â”‚      â”‚  Port 8001, 6379         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãƒãƒ«ãƒLLMçµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 2æ®µéšLLMå‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯**è»½é‡LLMã«ã‚ˆã‚‹æ„å›³è§£æ**ã¨**ãƒ¡ã‚¤ãƒ³LLMã«ã‚ˆã‚‹å¿œç­”ç”Ÿæˆ**ã‚’åˆ†é›¢ã—ãŸ2æ®µéšå‡¦ç†ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

#### ã‚¹ãƒ†ãƒƒãƒ—1: æ„å›³è§£æ (qwen2:0.5b)

**å®Ÿè£…ç®‡æ‰€**: `app/services/ollama_service.py:27-101`

```python
async def analyze_intent(self, message: str) -> Dict[str, Any]:
    """è»½é‡LLMã§é«˜é€Ÿãªæ„å›³è§£æ"""
```

**ç‰¹å¾´**:
- **è¶…è»½é‡ãƒ¢ãƒ‡ãƒ«** (0.5Bãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿) ã«ã‚ˆã‚‹é«˜é€Ÿå‡¦ç†
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: 0.3-0.5ç§’
- **æ¸©åº¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**: 0.1 (æ±ºå®šè«–çš„ãªè§£æ)
- **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé•·**: 200ãƒˆãƒ¼ã‚¯ãƒ³ (æ„å›³æŠ½å‡ºã«æœ€é©åŒ–)

**æŠ½å‡ºã•ã‚Œã‚‹æƒ…å ±**:

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | èª¬æ˜ | ä¾‹ |
|----------|------|---|
| `intent_type` | æ„å›³ã‚¿ã‚¤ãƒ— | `delay_resolution`, `resource_allocation`, `status_check` |
| `urgency` | ç·Šæ€¥åº¦ | `high`, `medium`, `low` |
| `requires_action` | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¦æ±‚ | `true`, `false` |
| `entities.location` | æ‹ ç‚¹å | `æœ­å¹Œ`, `æ±äº¬` |
| `entities.process` | å·¥ç¨‹å | `ã‚¨ãƒ³ãƒˆãƒª1`, `æ¢±åŒ…å·¥ç¨‹` |
| `entities.issue_type` | å•é¡Œã‚¿ã‚¤ãƒ— | `é…å»¶`, `äººå“¡ä¸è¶³` |

**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæˆ¦ç•¥**:
```
ã‚ãªãŸã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ„å›³ã‚’åˆ†æã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ä»¥ä¸‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åˆ†æã—ã€JSONå½¢å¼ã§çµæœã‚’è¿”ã—ã¦ãã ã•ã„ã€‚

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {message}

ä»¥ä¸‹ã®å½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼ˆJSONã®ã¿ã€ä»–ã®æ–‡ç« ã¯ä¸è¦ï¼‰ï¼š
{
  "intent_type": "delay_resolution|resource_allocation|status_check|general_inquiry",
  "urgency": "high|medium|low",
  "requires_action": true|false,
  "entities": {
    "location": "æ‹ ç‚¹åï¼ˆã‚ã‚Œã°ï¼‰",
    "process": "å·¥ç¨‹åï¼ˆã‚ã‚Œã°ï¼‰",
    "issue_type": "é…å»¶|äººå“¡ä¸è¶³|å“è³ªå•é¡Œ|ãã®ä»–"
  }
}
```

**ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
```python
"options": {
    "temperature": 0.1,      # æ±ºå®šè«–çš„ãªè§£æ
    "num_predict": 200,      # æœ€å¤§200ãƒˆãƒ¼ã‚¯ãƒ³
    "top_k": 10,             # ä¸Šä½10å€™è£œã‹ã‚‰é¸æŠ
    "top_p": 0.9             # ç´¯ç©ç¢ºç‡90%
}
```

---

#### ã‚¹ãƒ†ãƒƒãƒ—2: å¿œç­”ç”Ÿæˆ (gemma3:4b/12b/27b)

**å®Ÿè£…ç®‡æ‰€**: `app/services/ollama_service.py:103-201`

```python
async def generate_response(
    self,
    message: str,
    intent: Dict[str, Any],
    context: Optional[Dict[str, Any]] = None,
    db_data: Optional[Dict[str, Any]] = None,
    suggestion: Optional[Dict[str, Any]] = None
) -> str:
    """ãƒ¡ã‚¤ãƒ³LLMã§è©³ç´°ãªå¿œç­”ç”Ÿæˆ"""
```

**ç‰¹å¾´**:
- **é«˜æ€§èƒ½ãƒ¢ãƒ‡ãƒ«** (4B-27Bãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿) ã«ã‚ˆã‚‹è©³ç´°åˆ†æ
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: 1-4ç§’ (ãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚ºã«ã‚ˆã‚‹)
- **æ¸©åº¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**: 0.7 (å‰µé€ çš„ãªå¿œç­”)
- **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé•·**: 128K tokens (é•·æ–‡å¯¾å¿œ)

**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹æˆè¦ç´ **:

| è¦ç´  | å½¹å‰² | ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ |
|------|------|------------|
| æ„å›³æƒ…å ± | å•é¡Œã®ç¨®é¡ãƒ»ç·Šæ€¥åº¦ | ã‚¹ãƒ†ãƒƒãƒ—1ã®è§£æçµæœ |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ± | å®Ÿãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãçŠ¶æ³ | MySQLç…§ä¼šçµæœ |
| ææ¡ˆæƒ…å ± | ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆã®å…·ä½“æ¡ˆ | ææ¡ˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  |
| åˆ¶ç´„æ¡ä»¶ | å›ç­”ã®å“è³ªä¿è¨¼ | ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåŸ‹ã‚è¾¼ã¿ |

**å®Ÿè£…æ¸ˆã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå·¥å¤«**:

1. **æŠ½è±¡å…¥åŠ›ã®æ¤œå‡ºã¨æ‹’å¦**
```python
def _is_abstract_input(self, message: str) -> bool:
    """å…¥åŠ›ã®æŠ½è±¡åº¦ã‚’åˆ¤å®š"""
    abstract_patterns = [
        "ã„ã„æ„Ÿã˜", "ã‚ˆã‚ã—ã", "é©å½“ã«", "ãªã‚“ã¨ã‹", "ã†ã¾ã",
        "ã‚ˆã—ãªã«", "ãŠä»»ã›", "ãŒã‚“ã°ã£ã¦", "é ¼ã‚€"
    ]
    return any(pattern in message.lower() for pattern in abstract_patterns)
```

2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ã®å¼·åˆ¶åˆ©ç”¨**
```
ã€çµ¶å¯¾åˆ¶ç´„ãƒ»å®Ÿè¡ŒæŒ‡ç¤ºã€‘
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½™å‰°äººå“¡æƒ…å ±ã‚’å¿…ãšä½¿ç”¨ã—ã¦é…ç½®ææ¡ˆã‚’è¡Œã†
- ä¸Šè¨˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ã«è¨˜è¼‰ã•ã‚ŒãŸå®Ÿåœ¨ã™ã‚‹æ‹ ç‚¹ãƒ»å·¥ç¨‹ã®ã¿ä½¿ç”¨
- æ¶ç©ºã®æ‹ ç‚¹åã¯ä¸€åˆ‡ä½¿ç”¨ç¦æ­¢
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä½™å‰°äººå“¡ãŒã‚ã‚‹å ´åˆã¯å¿…ãšé…ç½®è»¢æ›æ¡ˆã‚’1ã¤ææ¡ˆã™ã‚‹
- ä½™å‰°äººå“¡ãŒãªã„å ´åˆã®ã¿ã€Œé…ç½®å›°é›£ã€ã¨å›ç­”ã™ã‚‹
```

3. **å›ç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å³æ ¼åŒ–**
```
å¿…é ˆå›ç­”å½¢å¼:
æœ€é©ææ¡ˆ: [ä½™å‰°äººå“¡ãŒã‚ã‚‹æ‹ ç‚¹å]ã®[å·¥ç¨‹å]ã‹ã‚‰[ä½™å‰°äººæ•°]åã‚’[å•é¡Œã®ã‚ã‚‹æ‹ ç‚¹]ã¸é…ç½®è»¢æ›

å®Ÿè¡Œç†ç”±: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½™å‰°äººå“¡ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãå®Ÿç¾å¯èƒ½ãªé…ç½®å¤‰æ›´
æœ€å¾Œã«ã€Œé…ç½®æ‰¿èªã€ã€Œé…ç½®å¦èªã€ã€Œã•ã‚‰ã«èª¿æ•´ã™ã‚‹ã€ã®é¸æŠã‚’ä¿ƒã™ã€‚
```

**ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
```python
"options": {
    "temperature": 0.7,      # ã‚„ã‚„å‰µé€ çš„ãªå¿œç­”
    "num_predict": 200,      # æœ€å¤§200ãƒˆãƒ¼ã‚¯ãƒ³
    "top_k": 20,             # ä¸Šä½20å€™è£œã‹ã‚‰é¸æŠ
    "top_p": 0.8             # ç´¯ç©ç¢ºç‡80%
}
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æº & RAGå®Ÿè£…

### æ„å›³ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿å–å¾—æˆ¦ç•¥

**å®Ÿè£…ç®‡æ‰€**: `app/services/database_service.py:15-321`

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯**RAG (Retrieval-Augmented Generation)** ã®åŸå‰‡ã«åŸºã¥ãã€LLMã®å¿œç­”ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ã¦ã„ã¾ã™ã€‚

#### æ„å›³ã‚¿ã‚¤ãƒ—åˆ¥ã‚¯ã‚¨ãƒªæˆ¦ç•¥

| æ„å›³ã‚¿ã‚¤ãƒ— | å–å¾—ãƒ‡ãƒ¼ã‚¿ | ã‚¯ã‚¨ãƒªæ•° | å¿œç­”æ™‚é–“ |
|----------|----------|---------|---------|
| `delay_resolution` | é…ç½®çŠ¶æ³ã€ç”Ÿç”£æ€§ãƒˆãƒ¬ãƒ³ãƒ‰ã€ä½™å‰°äººå“¡ã€ã‚¢ãƒ©ãƒ¼ãƒˆ | 4 | 0.2-0.3ç§’ |
| `resource_allocation` | ãƒªã‚½ãƒ¼ã‚¹æ¦‚è¦ã€ã‚¹ã‚­ãƒ«åˆ†å¸ƒ | 2 | 0.1-0.2ç§’ |
| `status_check` | é‹ç”¨çŠ¶æ³ã‚µãƒãƒªãƒ¼ | 1 | 0.05-0.1ç§’ |
| `general_inquiry` | æ‹ ç‚¹ä¸€è¦§ã€ãƒ—ãƒ­ã‚»ã‚¹ä¸€è¦§ | 2 | 0.05-0.1ç§’ |

---

### é…å»¶è§£æ±ºç”¨ãƒ‡ãƒ¼ã‚¿å–å¾— (æœ€ã‚‚è¤‡é›‘ãªã‚±ãƒ¼ã‚¹)

**å®Ÿè£…ç®‡æ‰€**: `app/services/database_service.py:54-170`

#### ã‚¯ã‚¨ãƒª1: ç¾åœ¨ã®é…ç½®çŠ¶æ³

**ç›®çš„**: äººå“¡ä¸è¶³ã®å·¥ç¨‹ã‚’ç‰¹å®š

```sql
SELECT
    da.assignment_id,
    l.location_name,
    p.process_name,
    COUNT(da.operator_id) as allocated_count,
    5 as required_count,
    (5 - COUNT(da.operator_id)) as shortage,  -- ä¸è¶³äººæ•°ã‚’è¨ˆç®—
    da.assignment_date
FROM daily_assignments da
JOIN locations l ON da.location_id = l.location_id
LEFT JOIN processes p ON da.business_id = p.business_id
    AND da.process_id = p.process_id
WHERE l.location_name LIKE :location
AND da.assignment_date = CURDATE()
GROUP BY da.assignment_id, l.location_name, p.process_name, da.assignment_date
ORDER BY shortage DESC  -- ä¸è¶³ãŒå¤§ãã„é †
```

**ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆ**:
- `LIKE` æ¤œç´¢ã§æŸ”è»Ÿãªæ‹ ç‚¹åãƒãƒƒãƒãƒ³ã‚°
- `shortage DESC` ã§ç·Šæ€¥åº¦ã®é«˜ã„å·¥ç¨‹ã‚’å„ªå…ˆè¡¨ç¤º
- `CURDATE()` ã§å½“æ—¥ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å–å¾—ï¼ˆé«˜é€ŸåŒ–ï¼‰

**è¿”å´ãƒ‡ãƒ¼ã‚¿ä¾‹**:
```python
[
    {
        "location_name": "æœ­å¹Œ",
        "process_name": "ã‚¨ãƒ³ãƒˆãƒª1",
        "allocated_count": 3,
        "required_count": 5,
        "shortage": 2  # 2åä¸è¶³
    }
]
```

---

#### ã‚¯ã‚¨ãƒª2: éå»7æ—¥é–“ã®ç”Ÿç”£æ€§ãƒˆãƒ¬ãƒ³ãƒ‰

**ç›®çš„**: ç”Ÿç”£æ€§ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é…ç½®åŠ¹æœã‚’äºˆæ¸¬

```sql
SELECT
    DATE(owr.record_date) as date,
    l.location_name,
    p.process_name,
    AVG(owr.work_count) as avg_productivity,
    COUNT(DISTINCT owr.operator_id) as employee_count
FROM operator_work_records owr
JOIN locations l ON owr.location_id = l.location_id
LEFT JOIN processes p ON owr.business_id = p.business_id
    AND owr.process_id = p.process_id
WHERE owr.record_date >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
AND (:location IS NULL OR l.location_name LIKE :location)
AND (:process IS NULL OR p.process_name LIKE :process)
GROUP BY DATE(owr.record_date), l.location_name, p.process_name
ORDER BY date DESC
```

**ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆ**:
- 7æ—¥é–“ã®ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’å–å¾—
- `AVG(work_count)` ã§å¹³å‡ç”Ÿç”£æ€§ã‚’ç®—å‡º
- NULLå¯¾å¿œã®æ¡ä»¶åˆ†å²ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æŸ”è»Ÿæ€§ã‚’ç¢ºä¿

**è¿”å´ãƒ‡ãƒ¼ã‚¿ä¾‹**:
```python
[
    {
        "date": "2025-10-02",
        "location_name": "æœ­å¹Œ",
        "process_name": "ã‚¨ãƒ³ãƒˆãƒª1",
        "avg_productivity": 82.5,
        "employee_count": 3
    }
]
```

---

#### ã‚¯ã‚¨ãƒª3: ä»–æ‹ ç‚¹ã®ä½™å‰°äººå“¡

**ç›®çš„**: é…ç½®è»¢æ›å¯èƒ½ãªãƒªã‚½ãƒ¼ã‚¹ã‚’ç™ºè¦‹

```sql
SELECT
    l.location_name,
    p.process_name,
    COUNT(DISTINCT da.operator_id) as allocated_count,
    5 as required_count,
    (COUNT(DISTINCT da.operator_id) - 5) as surplus,  -- ä½™å‰°äººæ•°
    GROUP_CONCAT(
        DISTINCT o.operator_name
        SEPARATOR ', '
    ) as available_employees  -- å…·ä½“çš„ãªã‚ªãƒšãƒ¬ãƒ¼ã‚¿å
FROM daily_assignments da
JOIN locations l ON da.location_id = l.location_id
LEFT JOIN processes p ON da.business_id = p.business_id
    AND da.process_id = p.process_id
LEFT JOIN operators o ON da.operator_id = o.operator_id
WHERE da.assignment_date = CURDATE()
AND (:process IS NULL OR p.process_name LIKE :process)
GROUP BY l.location_id, p.process_id, l.location_name, p.process_name
HAVING surplus > 0  -- ä½™å‰°ãŒã‚ã‚‹æ‹ ç‚¹ã®ã¿
ORDER BY surplus DESC  -- ä½™å‰°ãŒå¤šã„é †
LIMIT 10
```

**ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆ**:
- `HAVING surplus > 0` ã§ä½™å‰°äººå“¡ãŒã‚ã‚‹æ‹ ç‚¹ã®ã¿ã‚’æŠ½å‡º
- `GROUP_CONCAT` ã§é…ç½®è»¢æ›å¯èƒ½ãªã‚ªãƒšãƒ¬ãƒ¼ã‚¿åã‚’åˆ—æŒ™
- `LIMIT 10` ã§ä¸Šä½å€™è£œã®ã¿ã«çµã‚Šè¾¼ã¿ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰

**è¿”å´ãƒ‡ãƒ¼ã‚¿ä¾‹**:
```python
[
    {
        "location_name": "æ±äº¬",
        "process_name": "ã‚¨ãƒ³ãƒˆãƒª1",
        "allocated_count": 7,
        "required_count": 5,
        "surplus": 2,
        "available_employees": "ç”°ä¸­å¤ªéƒ, ä½è—¤èŠ±å­"
    }
]
```

---

#### ã‚¯ã‚¨ãƒª4: æœ€è¿‘ã®ã‚¢ãƒ©ãƒ¼ãƒˆæƒ…å ±

**ç›®çš„**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®æ´»å‹•çŠ¶æ³ã‚’æŠŠæ¡

```sql
SELECT
    lr.business_name,
    lr.process_name,
    lr.login_count,
    lr.record_time
FROM login_records lr
WHERE lr.record_time >= DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 24 HOUR), '%Y%m%d%H%i')
ORDER BY lr.record_time DESC
LIMIT 10
```

**ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆ**:
- 24æ™‚é–“ä»¥å†…ã®ãƒ­ã‚°ã‚¤ãƒ³è¨˜éŒ²ã®ã¿å–å¾—
- `DATE_FORMAT` ã§æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›
- `LIMIT 10` ã§æœ€æ–°10ä»¶ã«é™å®š

---

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒãƒªãƒ¼ç”Ÿæˆ

**å®Ÿè£…ç®‡æ‰€**: `app/services/ollama_service.py:203-243`

å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ã‚’LLMãŒç†è§£ã—ã‚„ã™ã„å½¢å¼ã«å¤‰æ›ã—ã¾ã™ã€‚

```python
def _create_db_summary(self, db_data: Dict[str, Any]) -> str:
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ã®ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆ"""
    summary_parts = []

    # äººå“¡ä¸è¶³ã®è©³ç´°
    if db_data.get("current_assignments"):
        assignments = db_data["current_assignments"]
        for a in assignments:
            shortage = a.get("shortage", 0)
            if shortage > 0:
                summary_parts.append(
                    f"- {a.get('location_name')}ã®{a.get('process_name')}ã§{shortage}åä¸è¶³"
                )

    # ä½™å‰°äººå“¡ã®è©³ç´°
    if db_data.get("available_resources"):
        resources = db_data["available_resources"]
        for r in resources:
            surplus = r.get("surplus", 0)
            if surplus > 0:
                summary_parts.append(
                    f"- {r.get('location_name')}ã®{r.get('process_name')}ã§{surplus}åä½™å‰°"
                )
                employees = r.get("available_employees", "")
                if employees:
                    summary_parts.append(f"  å¯¾è±¡è€…: {employees}")

    return "\n".join(summary_parts)
```

**ç”Ÿæˆä¾‹**:
```
- æœ­å¹Œã®ã‚¨ãƒ³ãƒˆãƒª1ã§2åä¸è¶³
- æ±äº¬ã®ã‚¨ãƒ³ãƒˆãƒª1ã§2åä½™å‰°
  å¯¾è±¡è€…: ç”°ä¸­å¤ªéƒ, ä½è—¤èŠ±å­
- å¤§é˜ªã®ã‚¨ãƒ³ãƒˆãƒª1ã§1åä½™å‰°
  å¯¾è±¡è€…: éˆ´æœ¨ä¸€éƒ
```

ã“ã®æƒ…å ±ãŒLLMã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åŸ‹ã‚è¾¼ã¾ã‚Œã€**å®Ÿãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸå¿œç­”**ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

---

## ææ¡ˆç”Ÿæˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

**å®Ÿè£…ç®‡æ‰€**: `app/services/integrated_llm_service.py:163-256`

### é…å»¶è§£æ±ºææ¡ˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

#### ã‚¹ãƒ†ãƒƒãƒ—1: ä¸è¶³ãƒ»ä½™å‰°ã®è¨ˆç®—

```python
async def _generate_delay_resolution_suggestion(
    self,
    intent: Dict[str, Any],
    db_data: Dict[str, Any],
    context: Optional[Dict[str, Any]] = None
) -> Dict[str, Any]:
    """é…å»¶è§£æ±ºã®ææ¡ˆã‚’ç”Ÿæˆ"""

    # ç¾åœ¨ã®ä¸è¶³çŠ¶æ³ã‚’ç¢ºèª
    target_process = db_data.get("target_process", [])
    if not target_process:
        target_process = db_data.get("current_assignments", [])

    # ä½™å‰°ãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºèª
    available_resources = db_data.get("available_resources", [])

    # ææ¡ˆã‚’æ§‹ç¯‰
    changes = []
    total_shortage = 0

    for assignment in target_process:
        shortage = assignment.get("shortage", 0)
        if shortage > 0:
            total_shortage += shortage
            location_name = assignment.get("location_name")
            process_name = assignment.get("process_name")

            # ä½™å‰°ãƒªã‚½ãƒ¼ã‚¹ã‹ã‚‰é…åˆ†
            allocated = 0
            for resource in available_resources:
                if allocated >= shortage:
                    break

                surplus = resource.get("surplus", 0)
                if surplus > 0 and resource.get("process_name") == process_name:
                    transfer_count = min(surplus, shortage - allocated)
                    changes.append({
                        "from": resource.get("location_name"),
                        "to": location_name,
                        "process": process_name,
                        "count": transfer_count
                    })
                    allocated += transfer_count
                    resource["surplus"] -= transfer_count  # æ¬¡ã®å‰²ã‚Šå½“ã¦ã®ãŸã‚ã«æ›´æ–°
```

**ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ç‰¹å¾´**:
1. **å„ªå…ˆåº¦ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒãƒ³ã‚°**: ä¸è¶³ãŒå¤§ãã„å·¥ç¨‹ã‹ã‚‰å„ªå…ˆçš„ã«é…åˆ†
2. **å·¥ç¨‹ä¸€è‡´æ€§**: åŒã˜å·¥ç¨‹å†…ã§ã®é…ç½®è»¢æ›ã‚’å„ªå…ˆ
3. **ãƒªã‚½ãƒ¼ã‚¹æ¶ˆè²»ç®¡ç†**: ä½™å‰°äººå“¡ã‚’é †æ¬¡æ¶ˆè²»ã—ã¦æœ€é©é…åˆ†

---

#### ã‚¹ãƒ†ãƒƒãƒ—2: å½±éŸ¿äºˆæ¸¬

```python
# ç”Ÿç”£æ€§ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å½±éŸ¿ã‚’æ¨å®š
productivity_trends = db_data.get("productivity_trends", [])
avg_productivity = 85.0  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
if productivity_trends:
    recent_productivity = [p.get("avg_productivity", 85) for p in productivity_trends[:3]]
    avg_productivity = sum(recent_productivity) / len(recent_productivity)

# ææ¡ˆã‚’ã¾ã¨ã‚ã‚‹
suggestion = {
    "id": f"SGT{datetime.now().strftime('%Y%m%d-%H%M%S')}",
    "changes": changes,
    "impact": {
        "productivity": f"+{min(15, total_shortage * 3)}%",
        "delay": f"-{min(30, total_shortage * 10)}åˆ†",
        "quality": "ç¶­æŒ" if total_shortage < 5 else "+2%"
    },
    "reason": self._generate_suggestion_reason(changes, avg_productivity),
    "confidence_score": min(0.95, 0.7 + len(changes) * 0.05)
}
```

**å½±éŸ¿äºˆæ¸¬ã®ãƒ­ã‚¸ãƒƒã‚¯**:
- **ç”Ÿç”£æ€§å‘ä¸Š**: ä¸è¶³äººæ•° Ã— 3% (ä¸Šé™15%)
- **é…å»¶å‰Šæ¸›**: ä¸è¶³äººæ•° Ã— 10åˆ† (ä¸Šé™30åˆ†)
- **å“è³ª**: 5åä»¥ä¸Šã®ä¸è¶³ã§å“è³ªå‘ä¸Šã‚’æœŸå¾…
- **ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢**: é…ç½®è»¢æ›æ•°ã«å¿œã˜ã¦å¢—åŠ  (åŸºæº–0.7ã€œæœ€å¤§0.95)

---

#### ã‚¹ãƒ†ãƒƒãƒ—3: ææ¡ˆç†ç”±ã®ç”Ÿæˆ

```python
def _generate_suggestion_reason(
    self,
    changes: List[Dict[str, Any]],
    avg_productivity: float
) -> str:
    """ææ¡ˆç†ç”±ã‚’ç”Ÿæˆ"""
    if not changes:
        return "ç¾åœ¨ã®ãƒªã‚½ãƒ¼ã‚¹ã§å¯¾å¿œå¯èƒ½ã§ã™"

    total_transfers = sum(c["count"] for c in changes)
    locations_involved = len(set(c["from"] for c in changes))

    reasons = []
    if avg_productivity < 80:
        reasons.append("ç”Ÿç”£æ€§å‘ä¸ŠãŒå¿…è¦")
    if total_transfers > 5:
        reasons.append("å¤§å¹…ãªäººå“¡ä¸è¶³ã‚’è§£æ¶ˆ")
    if locations_involved > 2:
        reasons.append("è¤‡æ•°æ‹ ç‚¹ã‹ã‚‰ã®å”åŠ›ä½“åˆ¶ã‚’æ§‹ç¯‰")

    if reasons:
        return "ã€".join(reasons) + f"ï¼ˆ{total_transfers}åã®é…ç½®èª¿æ•´ï¼‰"
    else:
        return f"{total_transfers}åã®é…ç½®èª¿æ•´ã«ã‚ˆã‚Šæœ€é©åŒ–ã‚’å®Ÿç¾"
```

**ææ¡ˆç†ç”±ã®åˆ¤æ–­åŸºæº–**:
- å¹³å‡ç”Ÿç”£æ€§ < 80%: ã€Œç”Ÿç”£æ€§å‘ä¸ŠãŒå¿…è¦ã€
- é…ç½®è»¢æ›äººæ•° > 5å: ã€Œå¤§å¹…ãªäººå“¡ä¸è¶³ã‚’è§£æ¶ˆã€
- é–¢ä¸æ‹ ç‚¹æ•° > 2: ã€Œè¤‡æ•°æ‹ ç‚¹ã‹ã‚‰ã®å”åŠ›ä½“åˆ¶ã‚’æ§‹ç¯‰ã€

---

### ææ¡ˆå‡ºåŠ›ä¾‹

```json
{
  "id": "SGT20251003-143052",
  "changes": [
    {
      "from": "æ±äº¬",
      "to": "æœ­å¹Œ",
      "process": "ã‚¨ãƒ³ãƒˆãƒª1",
      "count": 2
    }
  ],
  "impact": {
    "productivity": "+6%",
    "delay": "-20åˆ†",
    "quality": "ç¶­æŒ"
  },
  "reason": "ç”Ÿç”£æ€§å‘ä¸ŠãŒå¿…è¦ï¼ˆ2åã®é…ç½®èª¿æ•´ï¼‰",
  "confidence_score": 0.80
}
```

---

## LLMãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚° & ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæˆ¦ç•¥

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã®è¦ç‚¹

#### 1. æ§‹é€ åŒ–æŒ‡ç¤º (Structured Instructions)

**å®Ÿè£…ç®‡æ‰€**: `app/services/ollama_service.py:142-163`

```
ã€çµ¶å¯¾åˆ¶ç´„ãƒ»å®Ÿè¡ŒæŒ‡ç¤ºã€‘
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½™å‰°äººå“¡æƒ…å ±ã‚’å¿…ãšä½¿ç”¨ã—ã¦é…ç½®ææ¡ˆã‚’è¡Œã†
- ä¸Šè¨˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ã«è¨˜è¼‰ã•ã‚ŒãŸå®Ÿåœ¨ã™ã‚‹æ‹ ç‚¹ãƒ»å·¥ç¨‹ã®ã¿ä½¿ç”¨
- æ¶ç©ºã®æ‹ ç‚¹åã¯ä¸€åˆ‡ä½¿ç”¨ç¦æ­¢
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä½™å‰°äººå“¡ãŒã‚ã‚‹å ´åˆã¯å¿…ãšé…ç½®è»¢æ›æ¡ˆã‚’1ã¤ææ¡ˆã™ã‚‹
- ä½™å‰°äººå“¡ãŒãªã„å ´åˆã®ã¿ã€Œé…ç½®å›°é›£ã€ã¨å›ç­”ã™ã‚‹

å¿…é ˆå›ç­”å½¢å¼:
æœ€é©ææ¡ˆ: [ä½™å‰°äººå“¡ãŒã‚ã‚‹æ‹ ç‚¹å]ã®[å·¥ç¨‹å]ã‹ã‚‰[ä½™å‰°äººæ•°]åã‚’[å•é¡Œã®ã‚ã‚‹æ‹ ç‚¹]ã¸é…ç½®è»¢æ›

å®Ÿè¡Œç†ç”±: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½™å‰°äººå“¡ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãå®Ÿç¾å¯èƒ½ãªé…ç½®å¤‰æ›´
æœ€å¾Œã«ã€Œé…ç½®æ‰¿èªã€ã€Œé…ç½®å¦èªã€ã€Œã•ã‚‰ã«èª¿æ•´ã™ã‚‹ã€ã®é¸æŠã‚’ä¿ƒã™ã€‚
```

**åŠ¹æœ**:
- ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ (å¹»è¦š) ã‚’é˜²æ­¢
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ã¸ã®å¼·åˆ¶å‚ç…§
- å›ç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®çµ±ä¸€

---

#### 2. Few-Shot Learning (äº‹ä¾‹æç¤º)

ç¾åœ¨ã¯ã‚¼ãƒ­ã‚·ãƒ§ãƒƒãƒˆ (Zero-Shot) ã§ã™ãŒã€ä»Šå¾Œã®æ‹¡å¼µã¨ã—ã¦ä»¥ä¸‹ã‚’æ¤œè¨:

```
# è‰¯ã„ä¾‹
å…¥åŠ›: æœ­å¹Œã®ã‚¨ãƒ³ãƒˆãƒª1ã§2åä¸è¶³ã—ã¦ã„ã¾ã™
å‡ºåŠ›: æ±äº¬ã®ã‚¨ãƒ³ãƒˆãƒª1ã«2åä½™å‰°ãŒã‚ã‚‹ãŸã‚ã€æ±äº¬ã‹ã‚‰æœ­å¹Œã¸2åé…ç½®è»¢æ›ã‚’ææ¡ˆã—ã¾ã™ã€‚

# æ‚ªã„ä¾‹ï¼ˆæ¶ç©ºã®æ‹ ç‚¹ï¼‰
å…¥åŠ›: æœ­å¹Œã®ã‚¨ãƒ³ãƒˆãƒª1ã§2åä¸è¶³ã—ã¦ã„ã¾ã™
å‡ºåŠ›: æ¶ç©ºæ‹ ç‚¹Xã‹ã‚‰æœ­å¹Œã¸2åé…ç½®è»¢æ›ã‚’ææ¡ˆã—ã¾ã™ã€‚ â† NG
```

---

#### 3. Chain-of-Thought (æ€è€ƒã®é€£é–)

**å®Ÿè£…ç®‡æ‰€**: `app/services/integrated_llm_service.py:22-161`

```python
async def process_message(
    self,
    message: str,
    context: Optional[Dict[str, Any]] = None,
    db: Optional[AsyncSession] = None,
    detail: bool = False
) -> Dict[str, Any]:
    """4æ®µéšã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹"""

    # ã‚¹ãƒ†ãƒƒãƒ—1: æ„å›³è§£æ
    intent = await self.ollama_service.analyze_intent(message)

    # ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç…§ä¼š
    db_data = await self.db_service.fetch_data_by_intent(intent, context, db)

    # ã‚¹ãƒ†ãƒƒãƒ—3: ææ¡ˆç”Ÿæˆ
    suggestion = await self._generate_suggestion(intent, db_data, context)

    # ã‚¹ãƒ†ãƒƒãƒ—4: æœ€çµ‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ
    response_text = await self.ollama_service.generate_response(
        message, intent, context, db_data, suggestion
    )

    return {
        "response": response_text,
        "intent": intent,
        "suggestion": suggestion,
        "metadata": {...}
    }
```

**å„ã‚¹ãƒ†ãƒƒãƒ—ã®å½¹å‰²**:
1. **æ„å›³è§£æ**: å•é¡Œã®ç¨®é¡ã‚’ç‰¹å®š
2. **ãƒ‡ãƒ¼ã‚¿å–å¾—**: å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’åé›†
3. **ææ¡ˆç”Ÿæˆ**: ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§å…·ä½“æ¡ˆã‚’ä½œæˆ
4. **å¿œç­”ç”Ÿæˆ**: LLMã§è‡ªç„¶è¨€èªåŒ–

---

### æ¸©åº¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä½¿ã„åˆ†ã‘

| ãƒ¢ãƒ‡ãƒ« | æ¸©åº¦ | ç›®çš„ |
|-------|------|------|
| qwen2:0.5b (æ„å›³è§£æ) | 0.1 | æ±ºå®šè«–çš„ãªåˆ†é¡ |
| gemma3:4b (å¿œç­”ç”Ÿæˆ) | 0.7 | å‰µé€ çš„ã ãŒä¸€è²«æ€§ã®ã‚ã‚‹å¿œç­” |

**ç†ç”±**:
- **ä½æ¸© (0.1)**: æ„å›³è§£æã¯ã€Œæ­£è§£ã€ãŒã‚ã‚‹ã‚¿ã‚¹ã‚¯ãªã®ã§ç¢ºå®Ÿæ€§ã‚’é‡è¦–
- **ä¸­æ¸© (0.7)**: å¿œç­”ç”Ÿæˆã¯è‡ªç„¶ã•ã¨å¤šæ§˜æ€§ã®ãƒãƒ©ãƒ³ã‚¹ãŒé‡è¦

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. éåŒæœŸå‡¦ç†ã«ã‚ˆã‚‹ä¸¦åˆ—åŒ–

**å®Ÿè£…ç®‡æ‰€**: å…¨ä½“çš„ã« `async/await` ã‚’ä½¿ç”¨

```python
async def process_message(...):
    # ä¸¦åˆ—å®Ÿè¡Œå¯èƒ½ãªå‡¦ç†
    intent = await self.ollama_service.analyze_intent(message)
    db_data = await self.db_service.fetch_data_by_intent(intent, context, db)
```

**åŠ¹æœ**:
- LLMæ¨è«–ã¨DBç…§ä¼šã®å¾…ã¡æ™‚é–“ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—
- è¤‡æ•°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®åŒæ™‚å‡¦ç†ãŒå¯èƒ½

---

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªæœ€é©åŒ–

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

```sql
-- é…ç½®çŠ¶æ³ã®é«˜é€Ÿæ¤œç´¢
CREATE INDEX idx_daily_assignments_date ON daily_assignments(assignment_date);
CREATE INDEX idx_daily_assignments_location ON daily_assignments(location_id);

-- ç”Ÿç”£æ€§ãƒˆãƒ¬ãƒ³ãƒ‰ã®é«˜é€Ÿæ¤œç´¢
CREATE INDEX idx_work_records_date ON operator_work_records(record_date);
CREATE INDEX idx_work_records_operator ON operator_work_records(operator_id);
```

#### ã‚¯ã‚¨ãƒªãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

| æœ€é©åŒ–æ‰‹æ³• | å®Ÿè£…ç®‡æ‰€ | åŠ¹æœ |
|----------|---------|------|
| `LIMIT` å¥ | ä½™å‰°äººå“¡ã‚¯ã‚¨ãƒª | ä¸Šä½10ä»¶ã®ã¿å–å¾— |
| `CURDATE()` | é…ç½®çŠ¶æ³ã‚¯ã‚¨ãƒª | å½“æ—¥ãƒ‡ãƒ¼ã‚¿ã®ã¿ã«é™å®š |
| `HAVING` å¥ | ä½™å‰°äººå“¡ã‚¯ã‚¨ãƒª | ä½™å‰°ãŒã‚ã‚‹æ‹ ç‚¹ã®ã¿æŠ½å‡º |
| `DATE_SUB` | ç”Ÿç”£æ€§ãƒˆãƒ¬ãƒ³ãƒ‰ | 7æ—¥é–“ã®ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ |

---

### 3. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ æœ€é©åŒ–

| å‡¦ç† | æ™‚é–“ | æœ€é©åŒ–æ‰‹æ³• |
|------|------|-----------|
| æ„å›³è§£æ (qwen2:0.5b) | 0.3-0.5ç§’ | è»½é‡ãƒ¢ãƒ‡ãƒ«ä½¿ç”¨ |
| DBç…§ä¼š (4ã‚¯ã‚¨ãƒª) | 0.2-0.3ç§’ | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ– |
| ææ¡ˆç”Ÿæˆ | 0.05-0.1ç§’ | Pythonã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  |
| å¿œç­”ç”Ÿæˆ (gemma3:4b) | 1-2ç§’ | ãƒ¡ã‚¤ãƒ³LLM |
| **åˆè¨ˆ** | **1.5-3ç§’** | |

---

### 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° & ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

**å®Ÿè£…ç®‡æ‰€**: `app/services/ollama_service.py:187-201`

```python
try:
    response = await client.post(...)
    result = response.json()
    llm_response = result.get("response", "")

    # ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if not llm_response or llm_response.strip() == "":
        app_logger.warning("Empty response from LLM, using fallback")
        return self._generate_enhanced_mock_response(...)

except Exception as e:
    # ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
    if "memory" in str(e).lower() or "500" in str(e):
        app_logger.warning("Using fallback mock response due to LLM error")
        return self._generate_enhanced_mock_response(...)
```

**ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥**:
1. LLMå¿œç­”ãŒç©ºã®å ´åˆ â†’ å¼·åŒ–ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹
2. ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼ â†’ å¼·åŒ–ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹
3. ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ â†’ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿”å´

---

## ã‚³ãƒ¼ãƒ‰å‚ç…§

### ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œæ•° | ä¸»è¦æ©Ÿèƒ½ |
|---------|------|---------|
| `app/services/integrated_llm_service.py` | 324è¡Œ | çµ±åˆLLMã‚µãƒ¼ãƒ“ã‚¹ (æ„å›³è§£æâ†’DBç…§ä¼šâ†’ææ¡ˆâ†’å¿œç­”) |
| `app/services/database_service.py` | 321è¡Œ | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ (RAGãƒ‡ãƒ¼ã‚¿å–å¾—) |
| `app/services/ollama_service.py` | 413è¡Œ | OllamaLLMã‚µãƒ¼ãƒ“ã‚¹ (LLMé€šä¿¡) |
| `app/api/v1/endpoints/llm_test.py` | 108è¡Œ | ãƒ†ã‚¹ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |

---

### å‡¦ç†ãƒ•ãƒ­ãƒ¼è©³ç´°

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
   â†“
2. POST /api/v1/llm-test/integrated
   (llm_test.py:86-104)
   â†“
3. IntegratedLLMService.process_message()
   (integrated_llm_service.py:22-161)
   â”œâ”€ã‚¹ãƒ†ãƒƒãƒ—1: æ„å›³è§£æ
   â”‚  â””â”€ OllamaService.analyze_intent()
   â”‚     (ollama_service.py:27-101)
   â”‚
   â”œâ”€ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç…§ä¼š
   â”‚  â””â”€ DatabaseService.fetch_data_by_intent()
   â”‚     (database_service.py:15-321)
   â”‚     â”œâ”€ _fetch_delay_resolution_data() (4ã‚¯ã‚¨ãƒª)
   â”‚     â”œâ”€ _fetch_resource_allocation_data() (2ã‚¯ã‚¨ãƒª)
   â”‚     â”œâ”€ _fetch_status_data() (1ã‚¯ã‚¨ãƒª)
   â”‚     â””â”€ _fetch_general_data() (2ã‚¯ã‚¨ãƒª)
   â”‚
   â”œâ”€ã‚¹ãƒ†ãƒƒãƒ—3: ææ¡ˆç”Ÿæˆ
   â”‚  â””â”€ IntegratedLLMService._generate_suggestion()
   â”‚     (integrated_llm_service.py:163-256)
   â”‚
   â””â”€ã‚¹ãƒ†ãƒƒãƒ—4: å¿œç­”ç”Ÿæˆ
      â””â”€ OllamaService.generate_response()
         (ollama_service.py:103-201)
         â”œâ”€ _create_db_summary() (DBã‚µãƒãƒªãƒ¼ç”Ÿæˆ)
         â””â”€ _create_suggestion_summary() (ææ¡ˆã‚µãƒãƒªãƒ¼ç”Ÿæˆ)
```

---

## æŠ€è¡“çš„å¼·ã¿ãƒ»å·®åˆ¥åŒ–ãƒã‚¤ãƒ³ãƒˆ

### 1. ãƒãƒ«ãƒLLMã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

| å¾“æ¥æ‰‹æ³• | æœ¬ã‚·ã‚¹ãƒ†ãƒ  |
|---------|----------|
| å˜ä¸€LLMã§ã™ã¹ã¦å‡¦ç† | è»½é‡LLM(æ„å›³è§£æ) + é«˜æ€§èƒ½LLM(å¿œç­”ç”Ÿæˆ) |
| ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: 3-5ç§’ | ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: 1.5-3ç§’ |
| ã‚³ã‚¹ãƒˆ: é«˜ | ã‚³ã‚¹ãƒˆ: ä½ (è»½é‡ãƒ¢ãƒ‡ãƒ«æ´»ç”¨) |

---

### 2. RAGã«ã‚ˆã‚‹ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³é˜²æ­¢

| å¾“æ¥æ‰‹æ³• | æœ¬ã‚·ã‚¹ãƒ†ãƒ  |
|---------|----------|
| LLMã®çŸ¥è­˜ã®ã¿ã«ä¾å­˜ | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶å‚ç…§ |
| æ¶ç©ºã®æ‹ ç‚¹åã‚’ç”Ÿæˆ | å®Ÿåœ¨ã™ã‚‹æ‹ ç‚¹ã®ã¿ä½¿ç”¨ |
| ææ¡ˆã®å®Ÿç¾å¯èƒ½æ€§: ä¸æ˜ | ææ¡ˆã®å®Ÿç¾å¯èƒ½æ€§: ä¿è¨¼ |

---

### 3. 4æ®µéšå‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

```
æ„å›³è§£æ â†’ ãƒ‡ãƒ¼ã‚¿å–å¾— â†’ ææ¡ˆç”Ÿæˆ â†’ å¿œç­”ç”Ÿæˆ
(0.5ç§’)   (0.3ç§’)    (0.1ç§’)    (2ç§’)
```

å„ã‚¹ãƒ†ãƒƒãƒ—ãŒç‹¬ç«‹ã—ã¦ãŠã‚Šã€ãƒ‡ãƒãƒƒã‚°ãƒ»æ”¹å–„ãŒå®¹æ˜“

---

### 4. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°

- **çµ¶å¯¾åˆ¶ç´„**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ã®å¼·åˆ¶åˆ©ç”¨
- **å›ç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: çµ±ä¸€ã•ã‚ŒãŸææ¡ˆå½¢å¼
- **æŠ½è±¡å…¥åŠ›ã®æ‹’å¦**: å…·ä½“çš„ãªæƒ…å ±ã‚’è¦æ±‚

---

## ä»Šå¾Œã®æ‹¡å¼µå¯èƒ½æ€§

### 1. ChromaDBçµ±åˆ (ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢)

**ç¾çŠ¶**: æœªå®Ÿè£…
**æ‹¡å¼µæ¡ˆ**:
```python
# éå»ã®é¡ä¼¼ã‚±ãƒ¼ã‚¹ã‚’æ¤œç´¢
similar_cases = await chroma_service.search_similar_cases(
    query_vector=embed_message(message),
    top_k=3
)

# é¡ä¼¼ã‚±ãƒ¼ã‚¹ã®è§£æ±ºç­–ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è¿½åŠ 
prompt += f"\néå»ã®é¡ä¼¼äº‹ä¾‹:\n{similar_cases}"
```

---

### 2. Redis ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°

**ç¾çŠ¶**: æœªå®Ÿè£…
**æ‹¡å¼µæ¡ˆ**:
```python
# é »ç¹ãªã‚¯ã‚¨ãƒªçµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
cache_key = f"db_query:{intent_type}:{location}:{process}"
cached_result = await redis.get(cache_key)

if cached_result:
    return cached_result
else:
    result = await db.execute(query)
    await redis.setex(cache_key, 300, result)  # 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    return result
```

---

### 3. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹

**ç¾çŠ¶**: ãƒãƒƒãƒãƒ¬ã‚¹ãƒãƒ³ã‚¹
**æ‹¡å¼µæ¡ˆ**:
```python
async def generate_response_stream(...):
    async with httpx.AsyncClient() as client:
        async with client.stream(
            "POST",
            f"{self.main_base_url}/api/generate",
            json={"model": "gemma3:4b", "prompt": prompt, "stream": True}
        ) as response:
            async for chunk in response.aiter_text():
                yield chunk
```

**åŠ¹æœ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“æ„Ÿé€Ÿåº¦ã®å‘ä¸Š

---

## ã¾ã¨ã‚

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ä»¥ä¸‹ã®æŠ€è¡“çš„å·¥å¤«ã«ã‚ˆã‚Šã€**é«˜ç²¾åº¦ãƒ»é«˜é€Ÿãƒ»ä¿¡é ¼æ€§ã®é«˜ã„LLMãƒ™ãƒ¼ã‚¹ã®é…ç½®æœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ **ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™:

1. **ãƒãƒ«ãƒLLMã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: è»½é‡ãƒ¢ãƒ‡ãƒ«ã¨é«˜æ€§èƒ½ãƒ¢ãƒ‡ãƒ«ã®å½¹å‰²åˆ†æ‹…
2. **RAGçµ±åˆ**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Ÿãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãå¿œç­”ç”Ÿæˆ
3. **4æ®µéšå‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**: æ„å›³è§£æ â†’ ãƒ‡ãƒ¼ã‚¿å–å¾— â†’ ææ¡ˆç”Ÿæˆ â†’ å¿œç­”ç”Ÿæˆ
4. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°**: ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³é˜²æ­¢ã¨å›ç­”å“è³ªä¿è¨¼
5. **ææ¡ˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ã‹ã‚‰å®Ÿç¾å¯èƒ½ãªé…ç½®æ¡ˆã‚’ç”Ÿæˆ
6. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**: éåŒæœŸå‡¦ç†ã€ã‚¯ã‚¨ãƒªæœ€é©åŒ–ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

ã“ã‚Œã‚‰ã®å®Ÿè£…ã«ã‚ˆã‚Šã€**1.5-3ç§’ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**ã§**å®Ÿãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸä¿¡é ¼æ€§ã®é«˜ã„ææ¡ˆ**ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

